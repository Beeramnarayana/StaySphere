services:
  - type: web
    name: staysphere
    env: node
    buildCommand: |
      echo "🚀 Starting build process..."
      echo "📦 Node version: $(node -v)"
      echo "📦 NPM version: $(npm -v)"
      
      # Install root dependencies
      echo "\n📦 Installing root dependencies..."
      npm install --legacy-peer-deps
      
      # Install and build client
      echo "\n🔄 Setting up client..."
      cd client
      
      # Install client dependencies
      echo "\n📦 Installing client dependencies..."
      npm install --legacy-peer-deps
      
      # Build the client
      echo "\n🔨 Building client..."
      if ! npm run build; then
        echo "\n⚠️  Client build failed, but continuing with available files..."
        # Continue even if build fails
      fi
      
      # Verify build or public directory
      if [ -d "build" ]; then
        echo "\n✅ Build directory found at: $(pwd)/build"
        echo "Contents: $(ls -la build/)"
      elif [ -d "public" ]; then
        echo "\nℹ️  Using public directory as fallback"
        echo "Contents: $(ls -la public/)"
      else
        echo "\n❌ Neither build nor public directory found"
        echo "Current directory contents: $(ls -la)"
        # Don't exit with error to allow the server to start
      fi
      
      echo "\n🎉 Build process completed!"
      
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        fromDatabase:
          name: mongodb
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRE
        value: 30d
      - key: JWT_COOKIE_EXPIRE
        value: '30'
