services:
  - type: web
    name: staysphere
    env: node
    buildCommand: |
      echo "🚀 Starting build process..."
      echo "📦 Node version: $(node -v)"
      echo "📦 NPM version: $(npm -v)"
      
      # Install root dependencies
      echo "\n📦 Installing root dependencies..."
      npm install --legacy-peer-deps
      
      # Install and build client
      echo "\n🔄 Building client..."
      cd client
      npm install --legacy-peer-deps
      npm run build
      
      # Verify build
      if [ -d "build" ]; then
        echo "\n✅ Build verification:"
        echo "Build directory exists at: $(pwd)/build"
        echo "Contents: $(ls -la build/)"
      else
        echo "\n❌ Build verification failed: build directory not found"
        echo "Current directory: $(pwd)"
        echo "Directory contents: $(ls -la)"
        exit 1
      fi
      
      echo "\n🎉 Build process completed successfully!"
      
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        fromDatabase:
          name: mongodb
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRE
        value: 30d
      - key: JWT_COOKIE_EXPIRE
        value: '30'
